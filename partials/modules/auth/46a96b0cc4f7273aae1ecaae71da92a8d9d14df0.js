!function(){"use strict";angular.module("ecclesia.auth",["ngMaterial"]).factory("Auth",["$firebaseAuth",function(e){var r=new Firebase("https://congmap-sbg-test.firebaseio.com/");return e(r)}]).controller("authCtrl",["$rootScope","$scope","Auth","$mdSidenav","$location","$mdBottomSheet","$log","$q","$firebaseObject","$firebaseArray","$routeParams","mapsService",function(e,r,i,s,n,a,t,o,d,u,c,l){switch(r.$rootScope=e,e.showSideNav=!1,r.justRego=!1,r.isPending=!1,r.isMaint=!1,r.fbUsersUrl="https://congmap-sbg-test.firebaseio.com/users/",r.$routeParams=c,r.isResettingPwd=!1,r.loginUser=function(){return r.isPending?void t.info("Login cancelled, already in progress."):(r.loginFrm.$error.invaliduser=!1,r.isPending=!0,r.loginFrm.username.$invalid===!0||r.loginFrm.pw.$invalid===!0?void(r.isPending=!1):void i.$authWithPassword({email:r.email,password:r.pwd}).then(function(i){r.isPending=!1,i.password.isTemporaryPassword?n.path("/user/update"):(t.debug("Auth ok, redir to:"+e.getLandingPage()),n.path(e.getLandingPage()))})["catch"](function(e){switch(r.isPending=!1,e.code){case"INVALID_USER":case"INVALID_EMAIL":case"INVALID_PASSWORD":r.loginFrm.$error.invaliduser=!0}}))},r.setPwd=function(){return r.isPending?void t.info("Password change cancelled, already in progress."):(r.resetPwdFrm.$error.failchange=!1,r.resetPwdFrm.$error.pwdmismatch=!1,r.isPending=!0,r.newpwd!=r.confpwd?(r.isPending=!1,void(r.resetPwdFrm.$error.pwdmismatch=!0)):void i.$changePassword({email:i.$getAuth().password.email,oldPassword:r.oldpwd,newPassword:r.newpwd}).then(function(){r.isPending=!1,n.path(e.getLandingPage())})["catch"](function(e){t.error(e),r.resetPwdFrm.$error.failchange=!0,r.isPending=!1}))},r.registerUser=function(){r.isPending=!0;var e=""+Math.random(),i=new Firebase(r.fbUsersUrl);i.createUser({email:r.email,password:e},function(i,s){if(i)t.error(i);else{t.debug("Creating user...");var n=new Firebase(r.fbUsersUrl+s.uid);n.authWithPassword({email:r.email,password:e},function(e,i){e?t.error(e):n.set({email:r.email,status:0,id:s.uid},function(e){e?t.error(e):(n.unauth(),n.resetPassword({email:r.email},function(e){e?t.error(e):(r.justRego=!0,r.isPending=!1,r.$apply(),t.info("Validating email started..."))}))})})}})},c.action){case"update":r.isResettingPwd=!0,e.showSideNav=!0;break;case"logout":l.clearCache(),i.$unauth(),e.partialTitle="",n.path("/auth/login")}}]).service("authService",["$q","$firebaseObject","$firebaseArray",function(e,r,i){var s=this;s.fbUsersUrl="https://congmap-sbg-test.firebaseio.com/users/",s.roles={user:1,updater:2,admin:4},s.loadUser=function(){return s.userData||(s.userData=r(new Firebase(s.fbUsersUrl+s.currentAuth.uid))),s.userData},s.getUserInfoMin=function(){return s.userInfoMin={id:s.currentAuth.uid,name:s.userData.name},s.userInfoMin},s.whenUserLoaded=function(e){s.userData.$loaded().then(function(){e()})["catch"](function(e){console.error(e),$location.path("/auth/logout")})},s.isAdmin=function(e){s.whenUserLoaded(function(){e(s.isRole(s.userData.access,s.roles.admin))})},s.isUser=function(e){s.whenUserLoaded(function(){e(s.isRole(s.userData.access,s.roles.user))})},s.isUpdater=function(e){s.whenUserLoaded(function(){e(s.isRole(s.userData.access,s.roles.updater))})},s.isRole=function(e,r){return(e&r)===r}}])}();