!function(){"use strict";angular.module("ecclesia.maps").controller("mapsCtrl",["$rootScope","$scope","mapsService","currentAuth","$mdSidenav","$mdBottomSheet","$log","$q","$routeParams","$firebaseObject","$location","$mdDialog","authService","$filter","$timeout",function(e,a,t,s,n,d,o,r,i,l,p,c,m,u,f){a.$rootScope=e,a.headerTitle="",a.partialTitle="",a.statusSaveOk=!0,a.isMapStarted=!1,a.isPrintMode=p.path().indexOf("print")>=0,a.mapId=i.mapId,e.showSideNav=!a.isPrintMode,a.menuIsOpen=!1,m.currentAuth=s,m.loadUser().$loaded().then(function(){var e=m.getUserInfoMin().name;a.userCanExport="Shilo Banihit"==e||"Callum Frazier"==e||"Macgregor Dev"==e}),a.isPrintMode&&(a.headerTitle="Loading map data..."),a.statuses=t.statuses,a.saveStatus=function(){a.statusSaveOk=!1,t.saveStatus(a.mapObj.assgn,function(e){a.statusSaveOk=!0})},a.startMap=function(){a.statusSaveOk=!1,t.startMapAssgn(a.mapObj.assgn,function(e){e?(a.statusSaveOk=!0,a.isMapStarted=!0):a.statusSaveOk=!0})},a.loadPartial=function(){a.userData||(a.userData=t.userData=m.loadUser()),i.mapId?a.userData.$loaded().then(function(){t.loadAssignedMap(i.mapId,function(e){t.getFsgList(function(t){if(a.fsgListRef=t,a.mapObj=e,a.isMapStarted=void 0!=a.mapObj.assgn.started,a.orderAddresses(),a.isPrintMode){a.headerTitle=a.mapObj.mapData.terId+" - "+a.mapObj.mapData.name,a.printList=[];for(var s=null,n=33,d=0;d<a.mapObj.addresses.length;d++)null==s&&(s={addresses:[]},a.printList.push(s)),s.addresses.push(a.mapObj.addresses[d]),s.addresses.length==n&&(s=null,n=33)}else a.partialTitle=a.mapObj.mapData.terId+" - "+a.mapObj.mapData.name})})})["catch"](function(e){p.path("/auth/logout")}):a.userData.$loaded().then(function(){console.log("Loading map data..."),t.loadMyMaps(function(e){console.log("Loading started map data..."),t.getStartedMaps(function(s){console.log("Loading fsg list data..."),console.log(s),t.getFsgList(function(n){a.fsgListRef=n,a.fsgList=[];for(var d=0,o=u("orderBy"),r=0;r<n.length;r++)t.getFsgMapList(n[r].$value,function(t,r){a.fsgList.push({name:t,list:o(r,["data.terId"],!1)}),d++,d==n.length&&(a.startedMaps=s,a.allMapsList=o(e,["data.terId"],!1),a.mapListReady=!0)})})})})})["catch"](function(e){p.path("/auth/logout")})},a.saveNewAdd=function(e){e.$invalid||t.saveNewAdd(a.mapId,a.newAddress,function(e){console.log(e),c.hide(),e&&a.loadPartial()})},a.cancelNewAdd=function(){a.newAddress=null,c.hide()},a.addNewAddress=function(e){a.newAddress={},a.showAddrDialog(e,"New Address",a.newAddress,a.saveNewAdd,a.cancelNewAdd)},a.editAddress=function(e,t){a.showAddrDialog(e,"Edit Address",t.addData,a.saveEditAddr,a.cancelNewAdd,t)},a.deleteAddress=function(e,s){var n=c.confirm().title("Would you like to delete this address?").textContent("WARNING: This address will be permanently removed from the database. If you want to revisit this address (e.g. Do not call, Phone Witnessing, etc.), please mark it as as such.").ariaLabel("Delete address").targetEvent(e).ok("I'm sure, please do it!").cancel("Nope, that was scary!");c.show(n).then(function(){t.deleteAdd(a.mapObj,s,function(){a.loadPartial()},!0)},function(){})},a.deleteMap=function(e){if(a.mapObj.addresses.length>0||a.isMapStarted){var s="This map still has address(es), please move or delete address(es) before deleting map.";a.isMapStarted&&(s="This map is started, please complete this map and delete addresses before deleting this map.");var n=c.alert({title:"Delete Not Allowed",textContent:s,ok:'Okay, I understand that there are no shortcuts to destructive actions like "Delete".'});c.show(n)["finally"](function(){n=void 0})}else{var d=c.confirm().title("Would you like to delete this Map?").textContent("WARNING: This map will be permanently removed from the database. THERE WILL BE NO UNDO.").ariaLabel("Delete map").targetEvent(e).ok("I'm sure, please do it!").cancel("Nope, that was scary!");c.show(d).then(function(){t.deleteMap(a.mapObj,function(){a.goHome()})},function(){})}},a.saveEditAddr=function(e,a){console.log(e),console.log(a),t.saveEditAdd(a.addData,function(){c.hide()})},a.orderAddresses=function(){var e=u("orderBy");a.mapObj.addresses=e(a.mapObj.addresses,["mapAddRef.$priority"],!1)},a.bumpAdd=function(e,s){t.mapAddBump(e,s,a.mapObj),a.orderAddresses()},a.showAddrDialog=function(e,t,s,n,d,o){c.show({templateUrl:"partials/modules/maps/view/diag/addr.tpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,locals:{parentScope:a,title:t,saveTxt:"Save New Address",addr:s,addrRef:o,saveHdlr:n,cancelHdlr:d},controller:function(e,a,t,s,n,d,o,r,i){e.title=s,e.parentScope=t,e.newAddress=d,e.saveHdlr=r,e.saveTxt=n,e.addrRef=o,e.saveNewAdd=function(){r(e.newAddFrm,e.addrRef)},e.cancelNewAdd=i,t.newAddFrm=e.newAddFrm,-9==d.unit&&(d.unit="")}})},a.setExpiry=function(e){a.expiryDate=moment(a.mapObj.assgn.expiry).toDate(),console.log(a.expiryDate),c.show({templateUrl:"partials/modules/maps/view/diag/setExpiry.tpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,locals:{parentScope:a},controller:function(e,a,t){e.parentScope=t,e.expiryDate=t.expiryDate,e.saveExpiry=function(){t.saveExpiry(e.setExpiryForm)},e.cancelSetExpiry=t.cancelSetExpiry,t.setExpiryForm=e.setExpiryForm}})},a.cancelSetExpiry=function(){a.expiryDate=null,c.hide()},a.saveExpiry=function(){t.setMapExpiry(a.mapObj,a.expiryDate,function(){a.expiryDate=null,c.hide()})},a.resetMap=function(e){a.completionDate=new Date,c.show({templateUrl:"partials/modules/maps/view/diag/resetMap.tpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,locals:{parentScope:a},controller:function(e,a,t){e.parentScope=t,t.resetForm=e.resetForm}})},a.completeMap=function(){t.stopMapAssgn(a.mapObj,a.completionDate,function(){c.hide(),a.loadPartial()})},a.cancelResetMap=function(){c.hide()},a.goHome=function(){p.path("/maps/home")},a.getMapClass=function(e){var t=e.data,s=moment();if(a.startedMaps)for(var n=0;n<a.startedMaps.length;n++)if(a.startedMaps[n].id==e.id){var d=moment(t.assgn.expiry);return d.isAfter(s)?"md-warn md-hue-2":"md-warn md-hue-3"}if(t.lastCompleted){var o=moment(t.lastCompleted),r=moment().subtract(2,"month");return o.isAfter(r)?"md-warn md-hue-1":"md-accent md-hue-1"}return"md-primary"},a.openAddrMenu=function(e,a){console.log(a.target.type),void 0==a.target.type&&e(a)},a.moveAdd=function(e,t){a.mapSearchRes={found:!1,mapAddress:t},c.show({templateUrl:"partials/modules/maps/view/diag/moveMap.tpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,locals:{parentScope:a},controller:function(e,a,t){e.parentScope=t,t.moveAddForm=e.moveAddForm}})},a.cancelMoveAdd=function(){a.mapSearchRes=null,c.hide()},a.searchMapNum=function(){a.mapSearchRes.searching=!0,a.mapSearchRes.mapName="",a.mapSearchRes.found=!1,t.findMapByNum(a.mapSearchRes.mapNum,function(e){a.mapSearchRes.searching=!1,e.length>0&&(a.mapSearchRes.found=!0,a.mapSearchRes.target=e[0],a.mapSearchRes.mapName=e[0].value.name)})},a.moveAddToMap=function(){1==a.mapSearchRes.found?t.moveAddToMap(a.mapSearchRes.mapAddress.addId,a.mapSearchRes.target.value,a.mapSearchRes.target.key,function(){console.log("Map address"),console.log(a.mapSearchRes.mapAddress),t.deleteAdd(a.mapObj,a.mapSearchRes.mapAddress,function(){a.mapSearchRes=null,c.hide(),a.loadPartial()},!1)}):o.debug("No map specified to move to.")},a.editMap=function(e){a.editMapData={fsgListRef:a.fsgListRef,mapRef:a.mapObj.mapData,saving:!1,fromFsgName:a.mapObj.mapData.fsg},c.show({templateUrl:"partials/modules/maps/view/diag/map.tpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,locals:{parentScope:a,title:"Edit Map",map:a.editMapData},controller:function(e,a,t,s,n){e.parentScope=t,t.editMapForm=e.editMapForm,e.map=n}}),o.debug(a.editMapData)},a.cancelEditMap=function(){a.editMapData=null,c.hide()},a.saveEditMap=function(){a.editMapData.saving=!0,null==a.editMapData.fromFsgName?t.addNewMap(a.editMapData.mapRef.name,a.editMapData.mapRef.fsg,function(){a.editMapData=null,c.hide(),a.loadPartial()}):t.moveMapToFsg(a.mapId,a.editMapData.mapRef,a.editMapData.fromFsgName,a.editMapData.mapRef.fsg,function(){a.editMapData=null,c.hide()})},a.exportMapToCsv=function(e,t){var s=[["Address Title","House Number","Street","Suburb","State","Latitude","Longitude"]],n="data:text/csv;charset=utf-8,",d=a.getAddrArr(t);s=s.concat(d);var n=a.arrToCsv(s);a.downloadHref=encodeURI(n),a.downloadFile=a.mapObj.mapData.terId+".csv";var o=document.getElementById("downloadA");f(function(){o.click()})},a.getAddrArr=function(e){o.debug(e),o.debug("-------------------------");var a=[];return angular.forEach(e.addresses,function(t){a.push([e.mapData.terId+"|"+e.mapData.name,t.addData.hnum,t.addData.st,t.addData.burb,null==t.addData.state?"Queensland":t.addData.state,t.addData.clat,t.addData.clong])}),a},a.arrToCsv=function(e){var a="";return angular.forEach(e,function(t,s){var n='"'+t.join('","')+'"';a+=s<e.length?n+"\n":n}),a},a.exportAllMapsToCsv=function(e){var s=[["Address Title","House Number","Street","Suburb","State","Latitude","Longitude"]],n="data:text/csv;charset=utf-8,",d=0,r=0,i=0,l=[].concat(s),p=function(e){o.debug("Getting map:"+e.id),t.getMapAddr(e.id,function(e){var t=a.getAddrArr(e);if(l=l.concat(t),d++,o.debug("Map ctr: "+d+" of "+a.allMapsList.length),d>=a.allMapsList.length||d%20==0){var r=a.arrToCsv(l);a.downloadHref=encodeURI(n+r),a.downloadFile="AllMaps_"+i+".csv",i++;var c=document.getElementById("downloadA");f(function(){o.debug("Clicking"),c.click(),d<a.allMapsList.length&&(l=[].concat(s),p(a.allMapsList[d]))},500)}else p(a.allMapsList[d])}),r++};p(a.allMapsList[d])},a.addMap=function(e,t){a.editMapData={fsgListRef:a.fsgListRef,mapRef:{name:null,fsg:t},saving:!1,fromFsgName:null},c.show({templateUrl:"partials/modules/maps/view/diag/map.tpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,locals:{parentScope:a,title:"New Map",map:a.editMapData},controller:function(e,a,t,s,n){e.parentScope=t,t.editMapForm=e.editMapForm,e.map=n}})},a.shareMap=function(e){a.shareMapData={expiryDate:a.mapObj.assgn.shareExpiryDate?moment(a.mapObj.assgn.shareExpiryDate).toDate():moment().add(2,"weeks").toDate(),pubName:a.mapObj.assgn.sharePubName},c.show({templateUrl:"partials/modules/maps/view/diag/shareMap.tpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,locals:{parentScope:a},controller:function(e,a,t){e.parentScope=t,t.shareMapForm=e.shareMapForm}})},a.cancelShare=function(){a.shareMapData=null,c.hide()},a.saveShare=function(){t.shareMap(a.shareMapData.pubName,a.shareMapData.expiryDate,function(){a.cancelShare()})},a.loadPartial()}])}();